"use strict";
var __spreadArrays = (this && this.__spreadArrays) || function () {
    for (var s = 0, i = 0, il = arguments.length; i < il; i++) s += arguments[i].length;
    for (var r = Array(s), k = 0, i = 0; i < il; i++)
        for (var a = arguments[i], j = 0, jl = a.length; j < jl; j++, k++)
            r[k] = a[j];
    return r;
};
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
var lodash_1 = __importDefault(require("lodash"));
var v1_1 = __importDefault(require("uuid/v1"));
var GactionsSession = /** @class */ (function () {
    function GactionsSession(gactions, conv) {
        this.gactions = gactions;
        this.conv = conv;
        this.platform = 'gactions';
        this.conv = conv;
        this.gactions = gactions;
    }
    GactionsSession.prototype.userId = function (id) {
        if (id === void 0) { id = v1_1.default(); }
        var userId = this.conv.user.storage.userId;
        if (!userId) {
            userId = this.conv.user.storage.userId = id;
        }
        return userId;
    };
    GactionsSession.prototype.send = function (params) {
        var _a;
        var _this = this;
        if (!lodash_1.default.isArray(params)) {
            params = [params];
        }
        params = params.map(function (obj) {
            var _a;
            if (obj.method) {
                obj.params = obj.params.map(function (param) {
                    if (param.buttons) {
                        param.buttons = new _this.gactions.Button(param.buttons);
                    }
                    if (param.image) {
                        param.image = new _this.gactions.Image(param.image);
                    }
                    return param;
                });
                return new ((_a = _this.gactions[obj.method]).bind.apply(_a, __spreadArrays([void 0], obj.params)))();
            }
            if (obj.text) {
                return obj.text;
            }
            return obj;
        });
        (_a = this.conv).ask.apply(_a, params);
    };
    Object.defineProperty(GactionsSession.prototype, "message", {
        get: function () {
            return {
                source: this.platform,
                agent: this.platform,
                user: this.user
            };
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(GactionsSession.prototype, "user", {
        get: function () {
            return {
                id: this.conv.user.storage.userId
            };
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(GactionsSession.prototype, "source", {
        get: function () {
            return this.message.source;
        },
        enumerable: true,
        configurable: true
    });
    return GactionsSession;
}());
exports.GactionsSession = GactionsSession;
